# ObjectSizerAgent

`ObjectSizerAgent` — это Java-агент, который измеряет размер объектов в памяти, включая вложенные объекты. Агент
работает на основе **Instrumentation API** JVM.

Этот инструмент можно использовать для:

- Оптимизации использования памяти.
- Изучения структуры данных и их потребления памяти.

---

## Основные возможности

1. **`getObjectSize(Object obj)`**  
   Определяет базовый размер объекта в байтах (без учёта вложенных объектов).

2. **`getFullObjectSize(Object obj)`**  
   Рассчитывает полный размер объекта, включая все вложенные объекты.

---

## Как подключить агент

### 1. Добавьте JAR-файл агента в проект

Сначала скачайте или скомпилируйте JAR-файл агента `ObjectSizerAgent.jar` и сохраните его в доступной директории.

### 2. Подключите агент к JVM

Используйте параметр `-javaagent` при запуске вашего приложения, чтобы подключить Java-агент:

```bash
java -javaagent:/path/to/ObjectSizerAgent.jar -cp . MainClass
```

- Замените `/path/to/ObjectSizerAgent.jar` на полный путь к файлу JAR агента.
- `MainClass` — это основной класс вашего приложения.

---

## Пример использования

После подключения агента, вы можете измерять размер объектов следующим образом.

### Пример 1: Измерение базового размера объекта

```java
String testString = "Hello, World!";
long size = ObjectSizerAgent.getObjectSize(testString);
System.out.

println("Размер объекта: "+size +" байт.");
```

### Пример 2: Полный размер объекта с вложенными структурами

```java
class Example {
    int id;
    String name;
}

Example example = new Example();
example.id =42;
example.name ="Test Object";

long fullSize = ObjectSizerAgent.getFullObjectSize(example);
System.out.

println("Полный размер объекта: "+fullSize +" байт.");
```

Добавьте код в ваш проект, чтобы использовать агента.

---

## Устранение проблем

### Ошибка `java.lang.reflect.InaccessibleObjectException`

Если при использовании агента вы сталкиваетесь с ошибкой `java.lang.reflect.InaccessibleObjectException`, это связано с
модульной системой Java, начиная с версии 9. Эта ошибка возникает при попытке агента получить доступ к закрытым полям
стандартных библиотек Java (например, классов `java.lang.String`).

**Решение:** Добавьте аргумент JVM, чтобы открыть модуль `java.base` для вашего агента.

```bash
--add-opens java.base/java.lang=ALL-UNNAMED
```

Пример команды для запуска:

```bash
java --add-opens java.base/java.lang=ALL-UNNAMED \
    -javaagent:/path/to/ObjectSizerAgent.jar \
    -cp . MainClass
```

#### Добавление параметра в IntelliJ IDEA

1. Откройте конфигурацию запуска в **Edit Configurations**.
2. Найдите поле `VM Options` и добавьте:
   ```text
   --add-opens java.base/java.lang=ALL-UNNAMED
   ```
3. Сохраните и перезапустите приложение.

---

## Полезные советы

- **Поддержка циклических зависимостей**: Агент обрабатывает графы объектов с циклическими ссылками, чтобы избежать
  бесконечной рекурсии.
- **Округление размеров:** JVM может округлять размеры объектов (выравнивание до 8 или 16 байт).
- **Кроссплатформенное использование:** Работает на различных JVM (HotSpot, OpenJ9 и др.), но результаты могут немного
  отличаться в зависимости от JVM и архитектуры процессора (x64, ARM).

---

## Требования

- Java 8+
- JVM с поддержкой `Instrumentation API`.

---

## Лицензия

Этот инструмент предоставляется "как есть". Используйте его для образовательных или исследовательских целей.